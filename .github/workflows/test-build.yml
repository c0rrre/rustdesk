name: Test Build (PR Check)

# Startet automatisch bei Pull Requests (Merge Requests)
on:
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch: # Erlaubt manuellen Test

jobs:
  test-build:
    name: Verify Build Integrity
    runs-on: windows-2022
    
    steps:
      # 1. Code holen
      - name: Checkout Source Code
        uses: actions/checkout@v3

      # 2. Umgebung aufsetzen
      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install vcpkg Dependencies
        run: |
          git clone https://github.com/microsoft/vcpkg
          .\vcpkg\bootstrap-vcpkg.bat
          .\vcpkg\vcpkg install --classic libvpx:x64-windows libyuv:x64-windows opus:x64-windows

      # 3. Test der Konfiguration (Simulation)
      # Prüft, ob Ihre Secrets korrekt gelesen werden können und die Dateien existieren
      - name: Test Configuration Injection
        shell: powershell
        env:
          MY_HOST: ${{ secrets.RS_HOST }}
          MY_KEY: ${{ secrets.RS_KEY }}
          MY_APP_NAME: ${{ secrets.APP_NAME }}
        run: |
          Write-Host "Teste Anpassung für: $env:MY_APP_NAME"

          # A. Config Datei (Server & Key)
          $configFile = "libs/hbb_common/src/config.rs"
          if (Test-Path $configFile) {
              Write-Host "Config Datei gefunden: OK"
              # Wir simulieren das Lesen, um sicherzugehen, dass keine Syntaxfehler im Skript sind
              $content = Get-Content $configFile -Raw
          } else {
              Write-Error "FEHLER: Config Datei nicht gefunden!"
              exit 1
          }

          # B. App Name (C++)
          $cppFile = "flutter/windows/runner/main.cpp"
          if (Test-Path $cppFile) {
             Write-Host "Main C++ Datei gefunden: OK"
          } else {
             Write-Error "FEHLER: Main C++ Datei nicht gefunden!"
             exit 1
          }

      # 4. Der Build-Test (Kompilieren ohne Upload)
      - name: Test Compilation (Build)
        run: |
          cd flutter
          flutter pub get
          flutter build windows --release

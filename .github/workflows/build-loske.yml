name: RustDesk Build

on:
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '.github/**'
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-portable:
    name: Build Windows Portable
    runs-on: windows-2022
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Environment Variables
        shell: bash
        run: |
          # Version Tag generieren
          echo "VERSION_TAG=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "FLUTTER_VERSION=3.24.5" >> $GITHUB_ENV

      - name: Install LLVM
        run: choco install llvm -y

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'

      - name: Install vcpkg Dependencies
        shell: bash
        run: |
          git clone https://github.com/microsoft/vcpkg
          ./vcpkg/bootstrap-vcpkg.bat
          ./vcpkg/vcpkg install --classic libvpx:x64-windows-static libyuv:x64-windows-static opus:x64-windows-static aom:x64-windows-static

      # Config Injektion (Fail-Safe & Multi-Path)
      - name: Inject Configuration
        shell: bash
        env:
          MY_HOST: ${{ secrets.RS_HOST }}
          MY_KEY: ${{ secrets.RS_KEY }}
          MY_APP_NAME: ${{ secrets.APP_NAME }}
        run: |
          echo "Start Configuration Injection..."

          # --- TEIL 1: Server Config (config.rs) ---
          # Wir prüfen beide möglichen Orte. Wenn beide existieren, ändern wir beide.
          # Das ist sicherer als zu raten.
          POSSIBLE_CONFIGS=("src/config.rs" "libs/hbb_common/src/config.rs")
          CONFIG_FOUND=false

          for CONF_FILE in "${POSSIBLE_CONFIGS[@]}"; do
            if [ -f "$CONF_FILE" ]; then
               echo "Gefunden & Bearbeite: $CONF_FILE"
               
               # Wir nutzen eine flexiblere Regex (.* statt exakter Leerzeichen)
               # Und wir nutzen '#' als Trennzeichen für sed, falls der Key '/' enthält
               sed -i "s#pub const RENDEZVOUS_SERVER.*=.*#pub const RENDEZVOUS_SERVER: \&'static str = \"$MY_HOST\";#g" "$CONF_FILE"
               sed -i "s#pub const RS_PUB_KEY.*=.*#pub const RS_PUB_KEY: \&'static str = \"$MY_KEY\";#g" "$CONF_FILE"
               
               CONFIG_FOUND=true
            fi
          done

          if [ "$CONFIG_FOUND" = false ]; then
             echo "WARNUNG: Keine config.rs gefunden!"
             # Wir brechen hier nicht ab, um zu sehen, ob der Rest läuft
          fi

          # --- TEIL 2: App Name (main.cpp) ---
          # Wir suchen die main.cpp im flutter Ordner
          CPP_FILE=$(find flutter -name "main.cpp" | head -n 1)
          
          if [ -f "$CPP_FILE" ]; then
             echo "Bearbeite C++ Titel in: $CPP_FILE"
             sed -i "s#L\"RustDesk\"#L\"$MY_APP_NAME\"#g" "$CPP_FILE"
          else
             echo "WARNUNG: main.cpp nicht gefunden."
          fi

          # --- TEIL 3: Pubspec (Beschreibung) ---
          PUBSPEC=$(find flutter -name "pubspec.yaml" | head -n 1)
          
          if [ -f "$PUBSPEC" ]; then
             echo "Bearbeite Pubspec: $PUBSPEC"
             sed -i "s#description: RustDesk#description: $MY_APP_NAME#g" "$PUBSPEC"
          else
             echo "WARNUNG: pubspec.yaml nicht gefunden."
          fi
          
          echo "Konfiguration abgeschlossen."
      # --- BUILD PROZESS ---

      - name: Build RustDesk Application
        shell: bash
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          VCPKG_DEFAULT_TRIPLET: x64-windows-static
        run: |
          echo "Start Build Script..."
          # Wir bauen alles (Bridge + Rust + Flutter)
          # skip-portable-pack verhindert den Absturz am Ende
          python3 ./build.py --portable --hwcodec --flutter --vram --skip-portable-pack
          
          echo "Build abgeschlossen. Prüfe Ergebnisse..."
          
          # Wir suchen die gebaute EXE
          BUILT_EXE=$(find flutter -name "*.exe" | grep "Release" | head -n 1)
          
          if [ -f "$BUILT_EXE" ]; then
              echo "EXE gefunden: $BUILT_EXE"
              
              # Ordner für den Packer vorbereiten
              mkdir -p rustdesk
              
              # Alles aus dem Release-Ordner in den 'rustdesk' Ordner kopieren
              BUILD_DIR=$(dirname "$BUILT_EXE")
              cp -r "$BUILD_DIR"/* ./rustdesk/
              
              echo "Dateien bereitgestellt in ./rustdesk/"
              ls rustdesk
          else
              echo "FEHLER: Keine EXE nach dem Build gefunden!"
              exit 1
          fi

      - name: Pack Portable Executable
        shell: bash
        run: |
          echo "Installiere Python Deps..."
          pushd ./libs/portable
          pip3 install -r requirements.txt
          
          echo "Starte Generator..."
          # Wir holen den Namen der EXE aus dem rustdesk Ordner
          EXE_NAME=$(find ../../rustdesk -name "*.exe" | head -n 1)
          
          if [ -z "$EXE_NAME" ]; then
             echo "FEHLER: Keine EXE im staging Ordner!"
             exit 1
          fi
          
          echo "Packe: $EXE_NAME"
          # Packen
          python3 ./generate.py -f ../../rustdesk/ -o . -e "$EXE_NAME"
          popd
          
          # Ergebnis sichern
          mkdir -p release_output
          # Der Packer nennt die Datei oft 'rustdesk-portable-packer.exe' oder ähnlich
          PACKED_EXE=$(find libs/portable -name "*packer.exe" | head -n 1)
          
          if [ -f "$PACKED_EXE" ]; then
              mv "$PACKED_EXE" "./release_output/TechnikHilfe_Portable_${{ env.VERSION_TAG }}.exe"
              echo "Erfolg! Datei liegt in release_output."
          else
              # Fallback: Manchmal landet es im target Ordner
              PACKED_EXE_2=$(find target -name "*packer.exe" | head -n 1)
              if [ -f "$PACKED_EXE_2" ]; then
                  mv "$PACKED_EXE_2" "./release_output/TechnikHilfe_Portable_${{ env.VERSION_TAG }}.exe"
              else 
                  echo "FEHLER: Gepackte Datei nicht gefunden."
                  find . -name "*.exe"
                  exit 1
              fi
          fi

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          files: release_output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: RustDesk Build

on:
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '.github/**'
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-portable:
    name: Build Windows Portable
    runs-on: windows-2022
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Environment Variables
        shell: bash
        run: |
          # Version Tag generieren
          echo "VERSION_TAG=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "FLUTTER_VERSION=3.24.5" >> $GITHUB_ENV

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'

      - name: Install Build Tools (LLVM & NASM)
        shell: powershell
        run: |
          Write-Host "Installiere LLVM und NASM..."
          choco install llvm -y
          choco install nasm -y

      - name: Install vcpkg Dependencies
        shell: powershell
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          Write-Host "Klone VCPKG Paketmanager..."
          git clone https://github.com/microsoft/vcpkg
          
          # WICHTIG: Wir nutzen exakt die Version, die RustDesk offiziell verwendet
          Push-Location vcpkg
          git reset --hard 120deac3062162151622ca4860575a33844ba10b
          Pop-Location
          
          .\vcpkg\bootstrap-vcpkg.bat
          
          Write-Host "Installiere Abh채ngigkeiten aus Manifest (Das dauert einen Moment)..."
          .\vcpkg\vcpkg install --triplet x64-windows-static --x-install-root="$env:VCPKG_ROOT\installed"

      - name: Inject Configuration
        shell: bash
        env:
          MY_HOST: ${{ secrets.RS_HOST }}
          MY_KEY: ${{ secrets.RS_KEY }}
          MY_APP_NAME: ${{ secrets.APP_NAME }}
        run: |
          echo "Start Configuration Injection..."

          POSSIBLE_CONFIGS=("src/config.rs" "libs/hbb_common/src/config.rs")
          
          for CONF_FILE in "${POSSIBLE_CONFIGS[@]}"; do
            if [ -f "$CONF_FILE" ]; then
               echo "Passe Server und Key an in: $CONF_FILE"
               
               # 1. Singular: RENDEZVOUS_SERVER
               sed -i "s|^.*pub const RENDEZVOUS_SERVER:.*$|pub const RENDEZVOUS_SERVER: \&'static str = \"$MY_HOST\";|g" "$CONF_FILE"
               
               # 2. Plural: RENDEZVOUS_SERVERS
               sed -i "s|^.*pub const RENDEZVOUS_SERVERS:.*$|pub const RENDEZVOUS_SERVERS: \&[\&str] = \&[\"$MY_HOST\"];|g" "$CONF_FILE"
               
               # 3. Public Key
               sed -i "s|^.*pub const RS_PUB_KEY:.*$|pub const RS_PUB_KEY: \&'static str = \"$MY_KEY\";|g" "$CONF_FILE"
            fi
          done

          echo "Passe App-Namen an..."
          
          # C++ Titel (Fenstername)
          CPP_FILE=$(find flutter -name "main.cpp" | head -n 1)
          if [ -f "$CPP_FILE" ]; then
             sed -i "s|L\"RustDesk\"|L\"$MY_APP_NAME\"|g" "$CPP_FILE"
          fi

          # Pubspec Beschreibung
          PUBSPEC=$(find flutter -name "pubspec.yaml" | head -n 1)
          if [ -f "$PUBSPEC" ]; then
             sed -i "s|description: RustDesk|description: $MY_APP_NAME|g" "$PUBSPEC"
          fi

      - name: Build RustDesk Application
        shell: powershell
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
          VCPKG_DEFAULT_TRIPLET: x64-windows-static
        run: |
          Write-Host "Start Build Script..."
          # Python in PowerShell aufrufen
          python build.py --portable --hwcodec --flutter --vram --skip-portable-pack
          
          Write-Host "Build abgeschlossen. Pr체fe Ergebnisse..."
          
          # Pr체fen, ob der Ordner existiert, und ihn verschieben
          $sourceDir = "flutter\build\windows\x64\runner\Release"
          
          if (Test-Path $sourceDir) {
              Write-Host "Release Ordner gefunden! Verschiebe nach ./rustdesk..."
              # Das entspricht dem 'mv' Befehl des Original-Repos
              Move-Item -Path $sourceDir -Destination "rustdesk" -Force
              Write-Host "Dateien bereitgestellt in ./rustdesk/"
          } else {
              Write-Error "FEHLER: Release Ordner nach dem Build nicht gefunden!"
              exit 1
          }

      - name: Pack Portable Executable
        shell: powershell
        run: |
          Write-Host "Installiere Python Deps..."
          Push-Location ./libs/portable
          pip install -r requirements.txt
          
          Write-Host "Starte Generator..."
          # Suche die EXE Datei
          $exeFile = Get-ChildItem -Path "../../rustdesk" -Filter "*.exe" | Select-Object -First 1
          
          if (-not $exeFile) {
             Write-Error "FEHLER: Keine EXE im staging Ordner!"
             exit 1
          }
          
          $exeName = $exeFile.Name
          Write-Host "Packe: $exeName"
          
          python generate.py -f "../../rustdesk/" -o . -e "$exeName"
          Pop-Location
          
          # Ergebnis sichern
          New-Item -ItemType Directory -Path "release_output" -Force | Out-Null
          
          # Suche nach der gepackten Datei (체berall, falls sie in target/ landet)
          $packedExe = Get-ChildItem -Path . -Recurse -Filter "*packer.exe" | Select-Object -First 1
          
          if ($packedExe) {
              $newName = "./release_output/TechnikHilfe_Portable_${{ env.VERSION_TAG }}.exe"
              Move-Item -Path $packedExe.FullName -Destination $newName -Force
              Write-Host "Erfolg! Datei wurde erstellt: $newName"
          } else {
              Write-Error "FEHLER: Gepackte Datei nicht gefunden."
              exit 1
          }

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          files: release_output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

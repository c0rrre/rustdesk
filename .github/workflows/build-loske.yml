name: RustDesk Build

on:
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '.github/**'
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-portable:
    name: Build Windows Portable
    runs-on: windows-2022
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Environment Variables
        shell: bash
        run: |
          # Version Tag generieren
          echo "VERSION_TAG=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "FLUTTER_VERSION=3.24.5" >> $GITHUB_ENV

      - name: Install LLVM
        run: choco install llvm -y

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'

      - name: Install vcpkg Dependencies
        shell: bash
        run: |
          git clone https://github.com/microsoft/vcpkg
          ./vcpkg/bootstrap-vcpkg.bat
          ./vcpkg/vcpkg install --classic libvpx:x64-windows-static libyuv:x64-windows-static opus:x64-windows-static aom:x64-windows-static

      # Config Injektion (angepasst für Bash)
      - name: Inject Configuration
        shell: bash
        env:
          MY_HOST: ${{ secrets.RS_HOST }}
          MY_KEY: ${{ secrets.RS_KEY }}
          MY_APP_NAME: ${{ secrets.APP_NAME }}
        run: |
          echo "Konfiguriere..."
          # Wir nutzen sed für Text-Ersetzung (funktioniert in Bash unter Windows super)
          
          # Config.rs - Achtung: Pfad kann variieren, wir suchen danach
          CONF_FILE=$(find . -name "config.rs" | head -n 1)
          if [ -f "$CONF_FILE" ]; then
             sed -i "s|pub const RENDEZVOUS_SERVER: &'static str = \".*\";|pub const RENDEZVOUS_SERVER: &'static str = \"$MY_HOST\";|g" "$CONF_FILE"
             sed -i "s|pub const RS_PUB_KEY: &'static str = \".*\";|pub const RS_PUB_KEY: &'static str = \"$MY_KEY\";|g" "$CONF_FILE"
             echo "Config updated: $CONF_FILE"
          fi

          # App Name in C++
          CPP_FILE=$(find . -name "main.cpp" | grep "windows/runner" | head -n 1)
          if [ -f "$CPP_FILE" ]; then
             sed -i "s|L\"RustDesk\"|L\"$MY_APP_NAME\"|g" "$CPP_FILE"
          fi

          # Pubspec
          sed -i "s|description: RustDesk|description: $MY_APP_NAME|g" pubspec.yaml

      # --- HIER BEGINNT DER OFFIZIELLE BUILD WEG ---

      - name: Build RustDesk Application
        shell: bash
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          VCPKG_DEFAULT_TRIPLET: x64-windows-static
        run: |
          echo "Start Build Script..."
          # Wir nutzen exakt die Flags aus dem originalen Repo
          # --skip-portable-pack ist wichtig, damit das Skript nicht am Ende abstürzt
          python3 ./build.py --portable --hwcodec --flutter --vram --skip-portable-pack
          
          echo "Build fertig. Verschiebe Dateien..."
          # Wir erstellen den Ordner, den der Packer erwartet
          mkdir -p rustdesk
          
          # Wir verschieben den Flutter-Build Output in den rustdesk Ordner
          # Das Original Repo macht: mv ./flutter/build/windows/x64/runner/Release ./rustdesk
          cp -r ./flutter/build/windows/x64/runner/Release/* ./rustdesk/
          
          # (Optional) Hier könnte man Treiber herunterladen, wir lassen es erstmal minimal
          # Wichtig ist, dass die .exe jetzt in ./rustdesk/rustdesk.exe liegen sollte (oder ähnlich)
          ls -R rustdesk/

      - name: Build Self-Extracted Executable (Portable)
        shell: bash
        run: |
          echo "Bereite Portable Packer vor..."
          
          # Manifest anpassen (aus Original Repo kopiert)
          sed -i '/dpiAware/d' res/manifest.xml
          
          pushd ./libs/portable
          pip3 install -r requirements.txt
          
          echo "Starte Generator..."
          # WICHTIG: Wir verweisen auf den 'rustdesk' Ordner, den wir oben erstellt haben
          # Wir suchen vorher kurz den Namen der EXE, da Flutter sie manchmal anders nennt
          EXE_NAME=$(find ../../rustdesk -name "*.exe" | head -n 1)
          echo "Gefundene EXE: $EXE_NAME"
          
          python3 ./generate.py -f ../../rustdesk/ -o . -e "$EXE_NAME"
          
          popd
          
          # Das Resultat holen (Cargo packt den Packer)
          # Im Original: mv ./target/release/rustdesk-portable-packer.exe ...
          # Wir müssen schauen wo cargo es hingelegt hat. Meistens target/release
          
          mkdir -p output
          find . -name "rustdesk-portable-packer.exe" -exec cp {} ./output/TechnikHilfe_Portable_${{ env.VERSION_TAG }}.exe \;
          
          echo "Resultat:"
          ls -l output/

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          files: output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

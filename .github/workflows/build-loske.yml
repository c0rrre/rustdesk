name: Auto-Build & Release (Merge)

on:
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '.github/**'       # Ignoriert alles im .github Ordner (Workflows, Renovate, etc.)
      - 'README.md'        # Ignoriert Änderungen an der Doku
      - 'LICENSE'          # Ignoriert Lizenz-Änderungen
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build Windows Client
    runs-on: windows-2022
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Generate Version Tag
        id: versioning
        shell: powershell
        run: |
          $date = Get-Date -Format "yyyy.MM.dd-HHmm"
          $tag = "v$date"
          echo "VERSION_TAG=$tag" >> $env:GITHUB_ENV
          Write-Host "Version: $tag"

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'

      - name: Install vcpkg Dependencies
        run: |
          git clone https://github.com/microsoft/vcpkg
          .\vcpkg\bootstrap-vcpkg.bat
          .\vcpkg\vcpkg install --classic libvpx:x64-windows-static libyuv:x64-windows-static opus:x64-windows-static aom:x64-windows-static

      - name: Inject Configuration & Branding (Auto-Detect)
        shell: powershell
        env:
          MY_HOST: ${{ secrets.RS_HOST }}
          MY_KEY: ${{ secrets.RS_KEY }}
          MY_APP_NAME: ${{ secrets.APP_NAME }}
        run: |
          Write-Host "Starte Konfiguration für: $env:MY_APP_NAME"

          # --- A. Config Datei (Server & Key) ---
          $foundFiles = Get-ChildItem -Path . -Recurse -Include "*.rs" | Select-String -Pattern "pub const RENDEZVOUS_SERVER" -List
          
          if ($foundFiles) {
              $configFile = $foundFiles[0].Path
              Write-Host "TREFFER: Config Datei gefunden: $configFile"
              
              $content = Get-Content $configFile -Raw
              # Server ersetzen
              $content = $content -replace 'pub const RENDEZVOUS_SERVER: &''static str = ".*?"', "pub const RENDEZVOUS_SERVER: &'static str = ""$env:MY_HOST"""
              # Key ersetzen
              $content = $content -replace 'pub const RS_PUB_KEY: &''static str = ".*?"', "pub const RS_PUB_KEY: &'static str = ""$env:MY_KEY"""
              
              Set-Content -Path $configFile -Value $content
              Write-Host " -> Server & Key wurden eingetragen."
          } else {
              Write-Warning "WARNUNG: Config Datei nicht gefunden! Server-Daten fehlen im Build."
          }

          # --- B. App Name (C++ Fenstertitel) ---
          $cppFiles = Get-ChildItem -Path . -Recurse -Include "main.cpp" | Select-String -Pattern 'window.Create\(L"RustDesk"' -List
          
          if ($cppFiles) {
             $cppFile = $cppFiles[0].Path
             Write-Host "TREFFER: Main C++ Datei gefunden: $cppFile"
             
             $cppContent = Get-Content $cppFile -Raw
             $cppContent = $cppContent -replace 'L"RustDesk"', "L""$env:MY_APP_NAME"""
             Set-Content -Path $cppFile -Value $cppContent
             Write-Host " -> Fenstertitel angepasst."
          }

          # --- C. App Name (Pubspec Beschreibung) ---
          $pubspecFiles = Get-ChildItem -Path . -Recurse -Include "pubspec.yaml" | Select-String -Pattern "name: rustdesk" -List
          if ($pubspecFiles) {
              $pubspec = $pubspecFiles[0].Path
              (Get-Content $pubspec) -replace 'description: RustDesk', "description: $env:MY_APP_NAME" | Set-Content $pubspec
              Write-Host " -> Pubspec Beschreibung angepasst."
          }
          
      - name: Install LLVM
        run: choco install llvm -y

      - name: Build Application
        shell: cmd
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
          VCPKG_DEFAULT_TRIPLET: x64-windows-static
        run: |
          :: 1. Bridge-Code generieren (ohne zu packen)
          python build.py --skip-portable-pack

          :: 2. In den Flutter-Ordner wechseln
          cd flutter
          
          :: 3. Abhängigkeiten laden und bauen
          flutter pub get
          flutter build windows --release

      - name: Package Portable (Single File)
        shell: cmd
        run: |
          # 1. Python-Tool installieren
          pip install brotli

          # 2. Die EXE Datei automatisch suchen (egal ob x64 oder nicht)
          Write-Host "Suche nach der gebauten .exe Datei..."
          $exeFile = Get-ChildItem -Path "flutter/build/windows" -Recurse -Filter "*.exe" | Where-Object { $_.FullName -like "*Release*" } | Select-Object -First 1

          if ($exeFile) {
            $buildDir = $exeFile.DirectoryName
            $exePath = $exeFile.FullName
            
            Write-Host "GEFUNDEN: $exePath"
            Write-Host "ORDNER: $buildDir"

            # 3. Das Verpackungs-Skript aufrufen
            # Wir übergeben den gefundenen Pfad dynamisch
            & python libs/portable/generate.py -f "$buildDir" -o . -e "$exePath"
          } else {
            Write-Error "FEHLER: Keine .exe Datei im Build-Ordner gefunden!"
            exit 1
          }

      - name: Prepare Artifact
        shell: powershell
        run: |
          # Das Python-Skript hat die portable Datei jetzt in den Hauptordner gelegt.
          # Wir suchen die neueste EXE hier im Root (.)
          
          # Wir filtern nach Dateien, die NICHT im flutter/ oder vcpkg/ Ordner sind
          $portableExe = Get-ChildItem -Path . -Filter "*.exe" | Where-Object { $_.FullName -notmatch "flutter|vcpkg" } | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          
          if ($portableExe) {
            $finalName = "TechnikHilfe_Loske_Portable_${{ env.VERSION_TAG }}.exe"
            Rename-Item -Path $portableExe.FullName -NewName $finalName
            
            echo "RELEASE_FILE=$finalName" >> $env:GITHUB_ENV
            Write-Host "Fertige Portable Datei: $finalName"
          } else {
            Write-Error "Portable EXE wurde nicht generiert!"
            exit 1
          }
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: Release ${{ env.VERSION_TAG }}
          body: |
             TechnikHilfe Loske (Portable Version).
             Einfach herunterladen und starten. Keine Installation nötig.
          files: ${{ env.RELEASE_FILE }}

      - name: Prepare Artifact
        shell: powershell
        run: |
          $buildDir = "flutter\build\windows\runner\Release"
          $exePath = Get-ChildItem -Path $buildDir -Filter "*.exe" | Select-Object -First 1
          if ($exePath) {
            $newName = "$buildDir\TechnikHilfe_Loske_${{ env.VERSION_TAG }}.exe"
            Rename-Item -Path $exePath.FullName -NewName $newName
            echo "RELEASE_FILE=$newName" >> $env:GITHUB_ENV
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: Release ${{ env.VERSION_TAG }}
          body: Automatisches Update.
          files: ${{ env.RELEASE_FILE }}

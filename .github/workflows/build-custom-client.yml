name: RustDesk Custom Build (Stable Lock)

on:
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '.github/**'
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-portable:
    name: Build Windows Portable
    runs-on: windows-2022
    env:
      # Globale Variablen für LLVM/Clang (Wichtig für hwcodec!)
      LIBCLANG_PATH: C:\Program Files\LLVM\bin
      LLVM_INSTALL_PATH: C:\Program Files\LLVM
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Environment Variables
        shell: bash
        run: |
          echo "VERSION_TAG=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "FLUTTER_VERSION=3.24.5" >> $GITHUB_ENV

      # --- 1. BRANDING ---
      - name: Apply Custom Branding
        shell: bash
        env:
          MY_APP_NAME: ${{ secrets.APP_NAME }}
        run: |
          echo "Wende Branding an..."
          
          if [ -n "$MY_APP_NAME" ]; then
             sed -i "s|description: RustDesk|description: $MY_APP_NAME|g" flutter/pubspec.yaml
             find flutter -name "main.cpp" -exec sed -i "s|L\"RustDesk\"|L\"$MY_APP_NAME\"|g" {} +
             find flutter -name "Runner.rc" -exec sed -i "s|VALUE \"FileDescription\", \"RustDesk\"|VALUE \"FileDescription\", \"$MY_APP_NAME\"|g" {} +
             find flutter -name "Runner.rc" -exec sed -i "s|VALUE \"ProductName\", \"RustDesk\"|VALUE \"ProductName\", \"$MY_APP_NAME\"|g" {} +
          fi

          if [ -f "logo.png" ]; then
             echo "Kopiere logo.png..."
             mkdir -p flutter/assets/images
             cp "logo.png" "flutter/assets/images/logo.png"
             find flutter -name "logo.png" -exec cp "logo.png" {} + || true
          fi

          if [ -f "app_icon.ico" ]; then
             echo "Kopiere app_icon.ico..."
             mkdir -p flutter/windows/runner/resources
             cp "app_icon.ico" "flutter/windows/runner/resources/app_icon.ico"
          fi

      # --- 2. SERVER KONFIGURATION ---
      - name: Inject Server Configuration
        shell: bash
        env:
          VAL_API: ${{ secrets.API_SERVER }}
          VAL_REND: ${{ secrets.RENDEZVOUS_SERVER }}
          VAL_KEY: ${{ secrets.RS_PUB_KEY }}
        run: |
          echo "Suche Konfigurationsdateien..."
          TARGETS=("src/config.rs" "libs/hbb_common/src/config.rs")
          
          for CONF in "${TARGETS[@]}"; do
            if [ -f "$CONF" ]; then
              echo "Bearbeite: $CONF"
              sed -i "s|^.*pub const API_SERVER:.*$|pub const API_SERVER: \&'static str = \"$VAL_API\";|g" "$CONF"
              sed -i "s|^.*pub const RENDEZVOUS_SERVER:.*$|pub const RENDEZVOUS_SERVER: \&'static str = \"$VAL_REND\";|g" "$CONF"
              sed -i "s|^.*pub const RENDEZVOUS_SERVERS:.*$|pub const RENDEZVOUS_SERVERS: \&[\&str] = \&[\"$VAL_REND\"];|g" "$CONF"
              sed -i "s|^.*pub const RS_PUB_KEY:.*$|pub const RS_PUB_KEY: \&'static str = \"$VAL_KEY\";|g" "$CONF"
              echo "Konfiguration angewendet."
            fi
          done

      # --- 3. BUILD TOOLS ---
      - name: Install Build Tools (LLVM & NASM)
        shell: powershell
        run: choco install llvm nasm -y

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'

      # --- 4. ABHÄNGIGKEITEN (VCPKG CLEAN) ---
      - name: Install vcpkg Dependencies
        shell: bash
        run: |
          rm -rf C:/vcpkg
          git clone https://github.com/microsoft/vcpkg C:/vcpkg
          pushd C:/vcpkg
          git reset --hard 120deac3062162151622ca4860575a33844ba10b
          ./bootstrap-vcpkg.bat
          popd
          C:/vcpkg/vcpkg install --triplet x64-windows-static --x-install-root="C:/vcpkg/installed"

      # --- 5. BRIDGE GENERIEREN ---
      - name: Generate Flutter Rust Bridge
        shell: bash
        run: |
          cargo install flutter_rust_bridge_codegen --version 1.80.1
          pushd flutter
          flutter pub get
          popd
          flutter_rust_bridge_codegen \
            --rust-input src/flutter_ffi.rs \
            --dart-output flutter/lib/generated_bridge.dart \
            --rust-output src/bridge_generated.rs \
            --c-output flutter/windows/runner/bridge_generated.h

      # --- 6. KOMPILIEREN (Ohne cargo update!) ---
      - name: Build RustDesk Application
        shell: powershell
        env:
          VCPKG_ROOT: C:\vcpkg
          VCPKG_DEFAULT_TRIPLET: x64-windows-static
        run: |
          Write-Host "Start Build Script..."
          
          # Wir entfernen 'cargo update', da es Versionen kaputt machen kann.
          # Wir vertrauen auf die Cargo.lock Datei.
          python build.py --portable --hwcodec --flutter --vram --skip-portable-pack
          
          $sourceDir = "flutter\build\windows\x64\runner\Release"
          Write-Host "Prüfe auf Build Output in: $sourceDir"
          
          if (-not (Test-Path $sourceDir)) {
            Write-Error "FEHLER: Build Output nicht gefunden! (Compiler abgestürzt)"
            exit 1
          }
          
          Write-Host "Gefunden! Verschiebe..."
          Move-Item -Path $sourceDir -Destination "rustdesk" -Force

      # --- 7. PACKEN ---
      - name: Pack Portable Executable
        shell: powershell
        run: |
          Push-Location ./libs/portable
          pip install -r requirements.txt
          
          $exeFile = Get-ChildItem -Path "../../rustdesk" -Filter "*.exe" | Select-Object -First 1
          if (-not $exeFile) { 
            Write-Error "KEINE EXE GEFUNDEN"
            exit 1 
          }
          
          Write-Host "Packe EXE: $($exeFile.Name)"
          python generate.py -f "../../rustdesk/" -o . -e "$($exeFile.Name)"
          Pop-Location
          
          New-Item -ItemType Directory -Path "release_output" -Force | Out-Null
          
          $packed = Get-ChildItem -Path . -Recurse -Filter "*packer.exe" | Select-Object -First 1
          
          if ($packed) {
              $finalName = "./release_output/${{ secrets.APP_NAME }}_Portable_${{ env.VERSION_TAG }}.exe"
              Move-Item $packed.FullName $finalName -Force
              Write-Host "ERFOLG! Datei erstellt: $finalName"
          } else {
              Write-Error "Packen fehlgeschlagen."
              exit 1
          }

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          files: release_output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
